#!/bin/bash
echo "ğŸ”“ å …ç‰¢ã‚µãƒ¼ãƒœãƒ­ãƒƒã‚¯è§£é™¤..."

python3 -c "
import sys
import time
sys.path.append('/home/ros2/ros2_ws/src/cobot')

def safe_robot_command(robot, command_name, command_func, *args):
    '''å®‰å…¨ãªãƒ­ãƒœãƒƒãƒˆã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ'''
    max_retries = 3
    for attempt in range(max_retries):
        try:
            result = command_func(*args)
            print(f'âœ… {command_name} æˆåŠŸ (è©¦è¡Œ {attempt + 1}): {result}')
            return result
        except Exception as e:
            print(f'âš ï¸ {command_name} å¤±æ•— (è©¦è¡Œ {attempt + 1}): {e}')
            if attempt < max_retries - 1:
                time.sleep(1)
            else:
                print(f'âŒ {command_name} æœ€çµ‚å¤±æ•—')
                return None

try:
    from pymycobot import MyCobot280
    print('ğŸ¤– ãƒ­ãƒœãƒƒãƒˆæ¥ç¶šä¸­...')
    robot = MyCobot280('/dev/ttyAMA0', 1000000)
    time.sleep(2)  # ååˆ†ãªæ¥ç¶šå¾…æ©Ÿ
    
    # ãƒ†ã‚£ãƒ¼ãƒãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰çŠ¶æ…‹ç¢ºèªï¼ˆãƒªãƒˆãƒ©ã‚¤ä»˜ãï¼‰
    is_free = safe_robot_command(robot, 'ãƒ†ã‚£ãƒ¼ãƒãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰ç¢ºèª', robot.is_free_mode)
    
    if is_free:
        print('ğŸ”„ ãƒ†ã‚£ãƒ¼ãƒãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰è§£é™¤ä¸­...')
        safe_robot_command(robot, 'ãƒ†ã‚£ãƒ¼ãƒãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰è§£é™¤', robot.set_free_mode, 0)
        time.sleep(2)  # ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆå¾…æ©Ÿ
    
    # ã‚µãƒ¼ãƒœãƒ­ãƒƒã‚¯è§£é™¤ï¼ˆãƒªãƒˆãƒ©ã‚¤ä»˜ãï¼‰
    safe_robot_command(robot, 'ã‚µãƒ¼ãƒœãƒ­ãƒƒã‚¯è§£é™¤', robot.release_all_servos)
    
    print('ğŸ‰ å…¨å‡¦ç†å®Œäº†')
    
except Exception as e:
    print(f'ğŸ’¥ è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼: {e}')
"

echo "âœ… å®Œäº†"
